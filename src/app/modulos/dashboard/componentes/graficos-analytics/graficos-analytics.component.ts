import { Component, OnInit, OnDestroy } from '@angular/core';\nimport { CommonModule } from '@angular/common';\nimport { HttpClientModule, HttpClient } from '@angular/common/http';\nimport { Subject, interval, takeUntil, switchMap } from 'rxjs';\n\ninterface DatosGrafico {\n  labels: string[];\n  datasets: Dataset[];\n}\n\ninterface Dataset {\n  label: string;\n  data: number[];\n  borderColor: string;\n  backgroundColor: string;\n  fill: boolean;\n  tension: number;\n}\n\n@Component({\n  selector: 'app-graficos-analytics',\n  standalone: true,\n  imports: [CommonModule, HttpClientModule],\n  template: `\n    <div class=\"contenedor-graficos\">\n      <div class=\"encabezado\">\n        <h2>Graficos Analíticos</h2>\n        <p>Visualización de métricas en tiempo real</p>\n      </div>\n\n      <div class=\"controles\">\n        <button \n          *ngFor=\"let p of periodos\" \n          [class.activo]=\"periodoSeleccionado === p\"\n          (click)=\"cambiarPeriodo(p)\"\n          [disabled]=\"cargando\"\n          class=\"btn-periodo\"\n        >\n          {{ p }}\n        </button>\n      </div>\n\n      <div class=\"indicador-carga\" *ngIf=\"cargando\">\n        <div class=\"spinner\"></div>\n        <p>Generando gráficos...</p>\n      </div>\n\n      <div class=\"grid-graficos\" *ngIf=\"!cargando && datosGraficos\">\n        <div class=\"tarjeta-grafico\">\n          <h3>Mensajes Chat vs Preguntas IA</h3>\n          <div class=\"canvas-placeholder\">\n            <p>Gráfico de líneas: Chat y IA por hora</p>\n          </div>\n        </div>\n\n        <div class=\"tarjeta-grafico\">\n          <h3>Tasa de Éxito IA</h3>\n          <div class=\"canvas-placeholder\">\n            <p>Gráfico de barras: Evolución diaria</p>\n          </div>\n        </div>\n\n        <div class=\"tarjeta-grafico\">\n          <h3>Costos de IA</h3>\n          <div class=\"canvas-placeholder\">\n            <p>Gráfico de área: Acumulado por día</p>\n          </div>\n        </div>\n\n        <div class=\"tarjeta-grafico\">\n          <h3>Disponibilidad del Sistema</h3>\n          <div class=\"canvas-placeholder\">\n            <p>Gráfico gauge: Porcentaje de uptime</p>\n          </div>\n        </div>\n      </div>\n\n      <div class=\"seccion-exportar\">\n        <h3>Exportar Reportes</h3>\n        <div class=\"botones-exportar\">\n          <button class=\"btn-exportar pdf\" (click)=\"exportarPDF()\" [disabled]=\"cargando\">\n            Descargar PDF\n          </button>\n          <button class=\"btn-exportar csv\" (click)=\"exportarCSV()\" [disabled]=\"cargando\">\n            Descargar CSV\n          </button>\n        </div>\n      </div>\n    </div>\n  `,\n  styles: [`\n    .contenedor-graficos {\n      padding: 2rem;\n      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n      min-height: 100vh;\n    }\n\n    .encabezado {\n      color: white;\n      margin-bottom: 2rem;\n      text-align: center;\n    }\n\n    .encabezado h2 {\n      margin: 0;\n      font-size: 2rem;\n    }\n\n    .encabezado p {\n      margin: 0.5rem 0 0 0;\n      opacity: 0.95;\n    }\n\n    .controles {\n      display: flex;\n      justify-content: center;\n      gap: 1rem;\n      margin-bottom: 2rem;\n      flex-wrap: wrap;\n    }\n\n    .btn-periodo {\n      padding: 0.8rem 2rem;\n      border: 2px solid rgba(255, 255, 255, 0.3);\n      background: rgba(255, 255, 255, 0.1);\n      color: white;\n      border-radius: 2rem;\n      font-weight: 600;\n      cursor: pointer;\n      transition: all 0.3s ease;\n    }\n\n    .btn-periodo:hover:not(:disabled) {\n      background: rgba(255, 255, 255, 0.2);\n      border-color: rgba(255, 255, 255, 0.5);\n    }\n\n    .btn-periodo.activo {\n      background: rgba(255, 255, 255, 0.9);\n      color: #667eea;\n      border-color: white;\n    }\n\n    .indicador-carga {\n      display: flex;\n      flex-direction: column;\n      align-items: center;\n      justify-content: center;\n      padding: 4rem 2rem;\n      color: white;\n    }\n\n    .spinner {\n      width: 50px;\n      height: 50px;\n      border: 4px solid rgba(255, 255, 255, 0.3);\n      border-top-color: white;\n      border-radius: 50%;\n      animation: spin 1s linear infinite;\n      margin-bottom: 1rem;\n    }\n\n    @keyframes spin {\n      to { transform: rotate(360deg); }\n    }\n\n    .grid-graficos {\n      display: grid;\n      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));\n      gap: 2rem;\n      margin-bottom: 3rem;\n    }\n\n    .tarjeta-grafico {\n      background: rgba(255, 255, 255, 0.95);\n      border-radius: 1rem;\n      padding: 1.5rem;\n      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);\n      transition: transform 0.3s ease, box-shadow 0.3s ease;\n    }\n\n    .tarjeta-grafico:hover {\n      transform: translateY(-8px);\n      box-shadow: 0 16px 48px rgba(0, 0, 0, 0.15);\n    }\n\n    .tarjeta-grafico h3 {\n      margin: 0 0 1rem 0;\n      color: #333;\n      font-size: 1.1rem;\n    }\n\n    .canvas-placeholder {\n      background: #f5f5f5;\n      border: 2px dashed #ddd;\n      border-radius: 0.5rem;\n      padding: 2rem;\n      text-align: center;\n      min-height: 250px;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      color: #999;\n    }\n\n    .seccion-exportar {\n      background: rgba(255, 255, 255, 0.95);\n      border-radius: 1rem;\n      padding: 2rem;\n      text-align: center;\n      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);\n    }\n\n    .seccion-exportar h3 {\n      margin: 0 0 1.5rem 0;\n      color: #333;\n    }\n\n    .botones-exportar {\n      display: flex;\n      justify-content: center;\n      gap: 1rem;\n      flex-wrap: wrap;\n    }\n\n    .btn-exportar {\n      padding: 1rem 2rem;\n      border: none;\n      border-radius: 0.5rem;\n      font-weight: 600;\n      cursor: pointer;\n      transition: all 0.3s ease;\n      font-size: 1rem;\n    }\n\n    .btn-exportar.pdf {\n      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n      color: white;\n    }\n\n    .btn-exportar.csv {\n      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);\n      color: white;\n    }\n\n    .btn-exportar:hover:not(:disabled) {\n      transform: scale(1.05);\n      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);\n    }\n\n    .btn-exportar:disabled {\n      opacity: 0.6;\n      cursor: not-allowed;\n    }\n\n    @media (max-width: 768px) {\n      .contenedor-graficos {\n        padding: 1rem;\n      }\n\n      .grid-graficos {\n        grid-template-columns: 1fr;\n        gap: 1rem;\n      }\n\n      .encabezado h2 {\n        font-size: 1.5rem;\n      }\n    }\n  `]\n})\nexport class GraficosAnalyticsComponent implements OnInit, OnDestroy {\n  periodos = ['ultima-hora', 'hoy', 'semanal'];\n  periodoSeleccionado = 'hoy';\n  cargando = false;\n  datosGraficos: DatosGrafico | null = null;\n  private destroy$ = new Subject<void>();\n\n  constructor(private http: HttpClient) {}\n\n  ngOnInit() {\n    this.cargarGraficos();\n    // Auto-refresh cada 60 segundos\n    interval(60000)\n      .pipe(\n        switchMap(() => {\n          this.cargando = true;\n          return this.http.get<DatosGrafico>(`/api/graficos/${this.periodoSeleccionado}`);\n        }),\n        takeUntil(this.destroy$)\n      )\n      .subscribe(\n        (datos) => {\n          this.datosGraficos = datos;\n          this.cargando = false;\n        },\n        (error) => {\n          console.error('Error cargando gráficos', error);\n          this.cargando = false;\n        }\n      );\n  }\n\n  ngOnDestroy() {\n    this.destroy$.next();\n    this.destroy$.complete();\n  }\n\n  cargarGraficos() {\n    this.cargando = true;\n    this.http.get<DatosGrafico>(`/api/graficos/${this.periodoSeleccionado}`)\n      .pipe(takeUntil(this.destroy$))\n      .subscribe(\n        (datos) => {\n          this.datosGraficos = datos;\n          this.cargando = false;\n        },\n        (error) => {\n          console.error('Error cargando gráficos', error);\n          this.cargando = false;\n        }\n      );\n  }\n\n  cambiarPeriodo(periodo: string) {\n    this.periodoSeleccionado = periodo;\n    this.cargarGraficos();\n  }\n\n  exportarPDF() {\n    this.cargando = true;\n    this.http.get(`/api/reportes/pdf/${this.periodoSeleccionado}`, {\n      responseType: 'blob'\n    }).pipe(takeUntil(this.destroy$)).subscribe(\n      (blob) => {\n        this.descargarArchivo(blob, `reporte_${this.periodoSeleccionado}.pdf`);\n        this.cargando = false;\n      },\n      (error) => {\n        console.error('Error exportando PDF', error);\n        this.cargando = false;\n      }\n    );\n  }\n\n  exportarCSV() {\n    this.cargando = true;\n    this.http.get(`/api/reportes/csv/${this.periodoSeleccionado}`, {\n      responseType: 'blob'\n    }).pipe(takeUntil(this.destroy$)).subscribe(\n      (blob) => {\n        this.descargarArchivo(blob, `reporte_${this.periodoSeleccionado}.csv`);\n        this.cargando = false;\n      },\n      (error) => {\n        console.error('Error exportando CSV', error);\n        this.cargando = false;\n      }\n    );\n  }\n\n  private descargarArchivo(blob: Blob, nombreArchivo: string) {\n    const url = window.URL.createObjectURL(blob);\n    const link = document.createElement('a');\n    link.href = url;\n    link.download = nombreArchivo;\n    link.click();\n    window.URL.revokeObjectURL(url);\n  }\n}\n