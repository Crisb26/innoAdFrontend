package com.innoad.servicio;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.DisplayName;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.test.context.ActiveProfiles;

import static org.junit.jupiter.api.Assertions.*; 
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.Matchers.*; 

/**
 * Tests unitarios para ServicioCacheRedis
 * Verifica operaciones de caché y TTL\n */
@SpringBootTest
@ActiveProfiles(\"test\")\n@DisplayName(\"ServicioCacheRedis - Tests de Cache Redis\")\npublic class ServicioCacheRedisTest {\n\n    @Autowired\n    private ServicioCacheRedis servicioCacheRedis;\n\n    @Autowired\n    private RedisTemplate<String, Object> redisTemplate;\n\n    private static final String ID_CONFIG_TEST = \"test-config-123\";\n    private static final String ID_PANTALLA_TEST = \"test-screen-456\";\n    private static final String ID_USUARIO_TEST = \"test-user-789\";\n\n    @BeforeEach\n    void setUp() {\n        // Limpiar Redis antes de cada test\n        redisTemplate.getConnectionFactory().getConnection().flushAll();\n    }\n\n    @Test\n    @DisplayName(\"Cachear y obtener configuración IA\")\n    void testCachearObtenerConfiguracionIA() {\n        // Given - Crear configuración de prueba\n        String configJson = \"{\\\"modelo\\\":\\\"gpt-4\\\",\\\"temperatura\\\":0.7}\";\n\n        // When - Cachear configuración\n        servicioCacheRedis.cachearConfiguracionIA(ID_CONFIG_TEST, configJson);\n\n        // Then - Verificar que se puede obtener\n        Object resultado = servicioCacheRedis.obtenerConfiguracionIA(ID_CONFIG_TEST);\n        assertNotNull(resultado, \"La configuración debe existir en caché\");\n        assertEquals(configJson, resultado.toString());\n    }\n\n    @Test\n    @DisplayName(\"Obtener configuración IA inexistente retorna null\")\n    void testObtenerConfiguracionIAInexistente() {\n        // When - Intentar obtener config que no existe\n        Object resultado = servicioCacheRedis.obtenerConfiguracionIA(\"config-inexistente\");\n\n        // Then - Debe ser null\n        assertNull(resultado);\n    }\n\n    @Test\n    @DisplayName(\"Cachear y obtener horario pantalla\")\n    void testCachearObtenerHorarioPantalla() {\n        // Given\n        String horarioJson = \"{\\\"inicio\\\":\\\"08:00\\\",\\\"fin\\\":\\\"20:00\\\"}\";\n\n        // When\n        servicioCacheRedis.cachearHorarioPantalla(ID_PANTALLA_TEST, horarioJson);\n\n        // Then\n        Object resultado = servicioCacheRedis.obtenerHorarioPantalla(ID_PANTALLA_TEST);\n        assertNotNull(resultado);\n        assertEquals(horarioJson, resultado.toString());\n    }\n\n    @Test\n    @DisplayName(\"Incrementar contador de rate limit\")\n    void testIncrementarContadorRateLimit() {\n        // Given\n        long inicial = 0;\n        String tipo = \"general\";\n        int segundos = 60;\n\n        // When - Incrementar 5 veces\n        for (int i = 0; i < 5; i++) {\n            servicioCacheRedis.incrementarContadorRateLimit(ID_USUARIO_TEST, tipo, segundos);\n        }\n\n        // Then - Debe ser 5\n        long contador = servicioCacheRedis.obtenerContadorRateLimit(ID_USUARIO_TEST, tipo);\n        assertEquals(5, contador);\n    }\n\n    @Test\n    @DisplayName(\"Contador rate limit retorna 0 si no existe\")\n    void testObtenerContadorRateLimitInexistente() {\n        // When\n        long contador = servicioCacheRedis.obtenerContadorRateLimit(\"user-inexistente\", \"general\");\n\n        // Then\n        assertEquals(0, contador);\n    }\n\n    @Test\n    @DisplayName(\"Limpiar configuración IA\")\n    void testLimpiarConfiguracionIA() {\n        // Given - Cachear algo\n        servicioCacheRedis.cachearConfiguracionIA(ID_CONFIG_TEST, \"test-config\");\n        assertNotNull(servicioCacheRedis.obtenerConfiguracionIA(ID_CONFIG_TEST));\n\n        // When - Limpiar\n        servicioCacheRedis.limpiarConfiguracionIA();\n\n        // Then - Debe ser null\n        assertNull(servicioCacheRedis.obtenerConfiguracionIA(ID_CONFIG_TEST));\n    }\n\n    @Test\n    @DisplayName(\"Limpiar horarios pantalla\")\n    void testLimpiarHorarioPantalla() {\n        // Given\n        servicioCacheRedis.cachearHorarioPantalla(ID_PANTALLA_TEST, \"test-horario\");\n        assertNotNull(servicioCacheRedis.obtenerHorarioPantalla(ID_PANTALLA_TEST));\n\n        // When\n        servicioCacheRedis.limpiarHorarioPantalla();\n\n        // Then\n        assertNull(servicioCacheRedis.obtenerHorarioPantalla(ID_PANTALLA_TEST));\n    }\n\n    @Test\n    @DisplayName(\"Múltiples contadores para diferentes usuarios\")\n    void testMultiplesContadores() {\n        // Given - Dos usuarios diferentes\n        String usuario1 = \"usuario-1\";\n        String usuario2 = \"usuario-2\";\n        String tipo = \"general\";\n\n        // When - Incrementar para ambos usuarios\n        servicioCacheRedis.incrementarContadorRateLimit(usuario1, tipo, 60);\n        servicioCacheRedis.incrementarContadorRateLimit(usuario1, tipo, 60);\n        servicioCacheRedis.incrementarContadorRateLimit(usuario2, tipo, 60);\n\n        // Then - Verificar contadores independientes\n        assertEquals(2, servicioCacheRedis.obtenerContadorRateLimit(usuario1, tipo));\n        assertEquals(1, servicioCacheRedis.obtenerContadorRateLimit(usuario2, tipo));\n    }\n}\n
