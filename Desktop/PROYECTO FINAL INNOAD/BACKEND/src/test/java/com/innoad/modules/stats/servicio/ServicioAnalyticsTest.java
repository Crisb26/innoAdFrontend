package com.innoad.modules.stats.servicio;

import com.innoad.modules.stats.dto.EstadisticasDTO;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.DisplayName;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.ActiveProfiles;

import static org.junit.jupiter.api.Assertions.*; 

/**\n * Tests unitarios para ServicioAnalytics\n * Verifica tracking de métricas y estadísticas\n */\n@SpringBootTest\n@ActiveProfiles(\"test\")\n@DisplayName(\"ServicioAnalytics - Tests de Tracking de Métricas\")\npublic class ServicioAnalyticsTest {\n\n    @Autowired\n    private ServicioAnalytics servicioAnalytics;\n\n    @BeforeEach\n    void setUp() {\n        // Resetear contadores antes de cada test\n        servicioAnalytics.resetearContadores();\n    }\n\n    @Test\n    @DisplayName(\"Registrar mensaje chat incrementa contador\")\n    void testRegistrarMensajeChat() {\n        // Given\n        long tiempoRespuesta = 150; // ms\n\n        // When\n        servicioAnalytics.registrarMensajeChat(tiempoRespuesta);\n        servicioAnalytics.registrarMensajeChat(250);\n        servicioAnalytics.registrarMensajeChat(100);\n\n        // Then - Obtener estadísticas de hoy\n        EstadisticasDTO stats = servicioAnalytics.obtenerEstadisticasHoy();\n        assertEquals(3, stats.getTotalMensajesChat());\n        assertTrue(stats.getTiempoPromedioRespuestaChat() > 0);\n    }\n\n    @Test\n    @DisplayName(\"Registrar pregunta IA con éxito\")\n    void testRegistrarPreguntaIAExitosa() {\n        // Given\n        long tiempo = 2500; // ms\n        long tokens = 150;\n        double costo = 0.05;\n        boolean exitosa = true;\n\n        // When\n        servicioAnalytics.registrarPreguntaIA(tiempo, tokens, costo, exitosa);\n        servicioAnalytics.registrarPreguntaIA(2000, 100, 0.04, true);\n        servicioAnalytics.registrarPreguntaIA(3000, 200, 0.06, false);\n\n        // Then\n        EstadisticasDTO stats = servicioAnalytics.obtenerEstadisticasHoy();\n        assertEquals(3, stats.getTotalPreguntasIA());\n        assertEquals(2, stats.getTotalRespuestasExitosas());\n        assertEquals(350, stats.getTokensUsadosHoy()); // 150 + 100 + 200\n        assertEquals(0.15, stats.getCostoHoyIA(), 0.01); // 0.05 + 0.04 + 0.06\n    }\n\n    @Test\n    @DisplayName(\"Registrar error\")\n    void testRegistrarError() {\n        // Given\n        String tipo = \"TIMEOUT\";\n        String mensaje = \"Timeout en consulta IA\";\n\n        // When\n        servicioAnalytics.registrarError(tipo, mensaje);\n        servicioAnalytics.registrarError(\"DATABASE_ERROR\", \"Conexión perdida\");\n\n        // Then\n        EstadisticasDTO stats = servicioAnalytics.obtenerEstadisticasHoy();\n        assertEquals(2, stats.getTotalErrores());\n    }\n\n    @Test\n    @DisplayName(\"Obtener estadísticas última hora\")\n    void testObtenerEstadisticasUltimaHora() {\n        // Given\n        servicioAnalytics.registrarMensajeChat(100);\n        servicioAnalytics.registrarPreguntaIA(2000, 100, 0.05, true);\n\n        // When\n        EstadisticasDTO stats = servicioAnalytics.obtenerEstadisticasUltimaHora();\n\n        // Then\n        assertNotNull(stats);\n        assertEquals(1, stats.getTotalMensajesChat());\n        assertEquals(1, stats.getTotalPreguntasIA());\n        assertEquals(\"ultima-hora\", stats.getPeriodo());\n    }\n\n    @Test\n    @DisplayName(\"Obtener estadísticas hoy\")\n    void testObtenerEstadisticasHoy() {\n        // Given\n        servicioAnalytics.registrarMensajeChat(150);\n        servicioAnalytics.registrarMensajeChat(200);\n\n        // When\n        EstadisticasDTO stats = servicioAnalytics.obtenerEstadisticasHoy();\n\n        // Then\n        assertNotNull(stats);\n        assertEquals(2, stats.getTotalMensajesChat());\n        assertEquals(\"hoy\", stats.getPeriodo());\n        assertNotNull(stats.getUltimaActualizacion());\n    }\n\n    @Test\n    @DisplayName(\"Obtener estadísticas semanales\")\n    void testObtenerEstadisticasSemanales() {\n        // Given\n        for (int i = 0; i < 7; i++) {\n            servicioAnalytics.registrarMensajeChat(100);\n            servicioAnalytics.registrarPreguntaIA(2000, 50, 0.03, true);\n        }\n\n        // When\n        EstadisticasDTO stats = servicioAnalytics.obtenerEstadisticasSemanales();\n\n        // Then\n        assertNotNull(stats);\n        assertTrue(stats.getTotalMensajesChat() >= 0); // Semanal acumula\n        assertTrue(stats.getTotalPreguntasIA() >= 0);\n        assertEquals(\"semanal\", stats.getPeriodo());\n    }\n\n    @Test\n    @DisplayName(\"Tasa de éxito IA calculada correctamente\")\n    void testTasaExitoIA() {\n        // Given - 3 exitosas, 1 fallida\n        servicioAnalytics.registrarPreguntaIA(2000, 100, 0.05, true);\n        servicioAnalytics.registrarPreguntaIA(2000, 100, 0.05, true);\n        servicioAnalytics.registrarPreguntaIA(2000, 100, 0.05, true);\n        servicioAnalytics.registrarPreguntaIA(2000, 100, 0.05, false);\n\n        // When\n        EstadisticasDTO stats = servicioAnalytics.obtenerEstadisticasHoy();\n\n        // Then - 3/4 = 75%\n        assertEquals(75.0, stats.getTasaExitoIA(), 0.1);\n    }\n\n    @Test\n    @DisplayName(\"Resetear contadores\")\n    void testResetearContadores() {\n        // Given\n        servicioAnalytics.registrarMensajeChat(100);\n        servicioAnalytics.registrarPreguntaIA(2000, 100, 0.05, true);\n        servicioAnalytics.registrarError(\"TEST\", \"Test error\");\n\n        EstadisticasDTO statsAntes = servicioAnalytics.obtenerEstadisticasHoy();\n        assertTrue(statsAntes.getTotalMensajesChat() > 0);\n\n        // When\n        servicioAnalytics.resetearContadores();\n\n        // Then\n        EstadisticasDTO statsDepues = servicioAnalytics.obtenerEstadisticasHoy();\n        assertEquals(0, statsDepues.getTotalMensajesChat());\n        assertEquals(0, statsDepues.getTotalPreguntasIA());\n        assertEquals(0, statsDepues.getTotalErrores());\n    }\n\n    @Test\n    @DisplayName(\"Tiempo promedio chat calculado correctamente\")\n    void testTiempoPromedioChat() {\n        // Given - 100, 200, 300 = promedio 200\n        servicioAnalytics.registrarMensajeChat(100);\n        servicioAnalytics.registrarMensajeChat(200);\n        servicioAnalytics.registrarMensajeChat(300);\n\n        // When\n        EstadisticasDTO stats = servicioAnalytics.obtenerEstadisticasHoy();\n\n        // Then\n        assertEquals(200, stats.getTiempoPromedioRespuestaChat(), 1);\n    }\n\n    @Test\n    @DisplayName(\"Múltiples operaciones concurrentes (thread-safety)\")\n    void testOperacionesConcurrentes() throws InterruptedException {\n        // Given - Simular 10 threads registrando eventos\n        Thread[] threads = new Thread[10];\n\n        for (int i = 0; i < 10; i++) {\n            threads[i] = new Thread(() -> {\n                servicioAnalytics.registrarMensajeChat(100);\n                servicioAnalytics.registrarPreguntaIA(2000, 100, 0.05, true);\n            });\n            threads[i].start();\n        }\n\n        // When - Esperar a que terminen todos\n        for (Thread t : threads) {\n            t.join();\n        }\n\n        // Then - Verificar que los contadores son correctos\n        EstadisticasDTO stats = servicioAnalytics.obtenerEstadisticasHoy();\n        assertEquals(10, stats.getTotalMensajesChat());\n        assertEquals(10, stats.getTotalPreguntasIA());\n    }\n}\n
